<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>EEID2024 – Advanced topics with bayesTPC</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="module" src="site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">EEID2024</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./schedule.html"> 
<span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#thermal-performance-curves-under-antibiotics" id="toc-thermal-performance-curves-under-antibiotics" class="nav-link active" data-scroll-target="#thermal-performance-curves-under-antibiotics">Thermal performance curves under antibiotics</a></li>
  <li><a href="#a-flexible-and-interpretable-model-for-thermal-performance-curves" id="toc-a-flexible-and-interpretable-model-for-thermal-performance-curves" class="nav-link" data-scroll-target="#a-flexible-and-interpretable-model-for-thermal-performance-curves">A flexible and interpretable model for thermal performance curves</a>
  <ul class="collapse">
  <li><a href="#adding-the-flextpc-function-to-bayestpc" id="toc-adding-the-flextpc-function-to-bayestpc" class="nav-link" data-scroll-target="#adding-the-flextpc-function-to-bayestpc">Adding the flexTPC function to bayesTPC</a></li>
  </ul></li>
  <li><a href="#advanced-topic-transformations-of-model-parameters" id="toc-advanced-topic-transformations-of-model-parameters" class="nav-link" data-scroll-target="#advanced-topic-transformations-of-model-parameters">Advanced topic: Transformations of model parameters</a></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection">Model selection</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Advanced topics with bayesTPC</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this section, we will see how to use a custom functional form for thermal performance curves that is not currently implemented in bayesTPC. We will also see how to process the output from bayesTPC to generate custom plots or get the posterior distribution of model parameters.</p>
<section id="thermal-performance-curves-under-antibiotics" class="level2">
<h2 class="anchored" data-anchor-id="thermal-performance-curves-under-antibiotics">Thermal performance curves under antibiotics</h2>
<p>Let’s take a look at a dataset of the temperature-dependence of the growth of the bacterium <em>Escherichia coli</em> in the presence of various antibiotic backgrounds (data originally from this <a href="https://journals.asm.org/doi/full/10.1128/msystems.00228-21">study</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>abdata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"ab_data.csv"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(abdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  drug1name drug2name drug1num drug2num  T  t sample          OD
1       ERY       GEN        4        6 37 24      1 0.368300008
2       ERY       GEN        4        6 37 24      2 0.404299991
3       ERY       GEN        4        6 37 24      3 0.423800008
4       ERY       GEN        4        6 37 24      4 0.427200006
5       ERY       GEN        4        6 22 24      1 0.004800001
6       ERY       GEN        4        6 22 24      2 0.005099999</code></pre>
</div>
</div>
<p>This dataset consists of optical density (OD) values (which are proportional to the number of bacteria) of <em>E. coli</em> cultures after 24 hour growth at various temperatures (T) under fixed concentrations of 12 antibiotics and all their pairwise combinations. There are four replicates per drug/temperature treatment.</p>
<p>In this workshop we will focus on comparing how the thermal performance for <em>E. coli</em> growth looks like under four conditions of interest:</p>
<ul>
<li>no antibiotic</li>
<li>gentamicin (GEN)</li>
<li>erythromycin (ERY)</li>
<li>GEN+ERY (both antibiotics present at the same time)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The data uses "WT" to encode "no drug".</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>nodrug <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>GEN <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"GEN"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>ERY <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"ERY"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>both <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"ERY"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"GEN"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start by plotting the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nodrug<span class="sc">$</span>T, nodrug<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"No drug"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(GEN<span class="sc">$</span>T, GEN<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ERY<span class="sc">$</span>T, ERY<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(both<span class="sc">$</span>T, both<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN+ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As might be expected, adding antibiotics to the growth media decreases the number of bacteria. However, they can decrease growth more at some temperatures than others, leading to changes in the shape of the TPC.</p>
<p>Some of the shapes you get when adding antibiotics do not look like typical TPCs and it could be difficult to fit this data with many common TPC models. In the following section, we show how we can add a new functional form to bayesTPC that can describe these TPCs.</p>
</section>
<section id="a-flexible-and-interpretable-model-for-thermal-performance-curves" class="level2">
<h2 class="anchored" data-anchor-id="a-flexible-and-interpretable-model-for-thermal-performance-curves">A flexible and interpretable model for thermal performance curves</h2>
<p>Now we introduce a new functional form for thermal performance curves called flexTPC. This model aims to be both flexible (aiming to describe unimodal TPC curves of any skewness) and interpretable (with all model parameters having a clear biological interpretation).</p>
<p>A preprint focusing on describing this model and showing its performance in various different datasets is in preparation and will be published soon. In the meantime, you can check the associated <a href="https://github.com/mcruzloya/flexTPC">GitHub</a>.</p>
<p>The equation for the flexTPC model is</p>
<p><span class="math display">\[
r(T) = r_{\max}\left[\left(\frac{T - T_{\min}}{\alpha} \right)^{\alpha} \left(\frac{T_{\max} - T}{1 - \alpha} \right)^{1-\alpha}
\left(\frac{1}{T_{\max} - T_{\min}} \right)
\right]^\frac{\alpha (1 - \alpha)}{\beta^2}
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(T_{\min}\)</span> is the minimum temperature,</li>
<li><span class="math inline">\(T_{\max}\)</span> the maximum temperature,</li>
<li><span class="math inline">\(r_{\max}\)</span> the maximum trait value/performance of the TPC,</li>
<li><span class="math inline">\(\alpha \in [0,1]\)</span> determines where the optimal temperature <span class="math inline">\(T_{\mathrm{opt}}\)</span> is relative to <span class="math inline">\(T_{\min}\)</span> and <span class="math inline">\(T_{\max}\)</span> through the equation <span class="math display">\[
T_{\mathrm{opt}} = \alpha T_{\max} + (1 - \alpha) T_{\min}
\]</span> (where, for example, <span class="math inline">\(\alpha = 0\)</span> corresponds to <span class="math inline">\(T_{\mathrm{opt}} = T_{\min}\)</span>, <span class="math inline">\(\alpha = 1\)</span> corresponds to <span class="math inline">\(T_{\mathrm{opt}} = T_{\max}\)</span> and <span class="math inline">\(\alpha = 1/2\)</span> corresponds to a symmetric TPC where <span class="math inline">\(T_{\mathrm{opt}} = (T_{\min} + T_{\max}) / 2\)</span>), and</li>
<li><span class="math inline">\(\beta &gt; 0\)</span> determines the breadth of the TPC near its peak.</li>
</ul>
<p>It may be more intuitive to look at how the predicted TPC changes as we modify each of these parameters. You can change each parameter in flexTPC in the visualization below to see how it affects the shape of the curve. As you can see, flexTPC can describe curves of a wide variety of shapes, as long as they are unimodal (that is, have a single peak).</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb5" data-startfrom="94" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 93;"><span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>viewof T_min <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  [<span class="op">-</span><span class="dv">5</span><span class="op">,</span> <span class="dv">20</span>]<span class="op">,</span> </span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.2</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Tmin:"</span>}</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>viewof T_max <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">30</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span> </span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="dv">35</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.2</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Tmax:"</span>}</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>viewof r_max <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">0</span><span class="op">,</span> <span class="fl">1.2</span>]<span class="op">,</span> </span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"rmax:"</span>}</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>viewof alpha <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> </span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.02</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"alpha:"</span>}</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>viewof beta <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> </span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.02</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"beta:"</span>}</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-5" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb6" data-startfrom="122" data-source-offset="-1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 121;"><span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">incrementalArray</span>(start<span class="op">,</span> end<span class="op">,</span> step) {</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> arr <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">// convert count to an integer to avoid rounding errors</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> count <span class="op">=</span> <span class="op">+</span>((end <span class="op">-</span> start) <span class="op">/</span> step)<span class="op">.</span><span class="fu">toFixed</span>()<span class="op">;</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">var</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;=</span> count<span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> i <span class="op">=</span> start <span class="op">+</span> j <span class="op">*</span> step<span class="op">;</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>        arr<span class="op">.</span><span class="fu">push</span>(i)<span class="op">;</span></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arr<span class="op">;</span></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">flexTPC</span>(x<span class="op">,</span> T_min<span class="op">,</span> T_max<span class="op">,</span> r_max<span class="op">,</span> alpha<span class="op">,</span> beta) {</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="op">&lt;</span> T_min) {</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="op">&gt;</span> T_max) {</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> r_max <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>((alpha <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> alpha) <span class="op">/</span> beta<span class="op">**</span><span class="dv">2</span>) <span class="op">*</span> (alpha <span class="op">*</span>    <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>( (x <span class="op">-</span> T_min) <span class="op">/</span> alpha)  <span class="op">+</span> </span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>      (<span class="fl">1.0</span> <span class="op">-</span> alpha) <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>( (T_max <span class="op">-</span> x) <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">-</span> alpha)) <span class="op">-</span></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>(T_max <span class="op">-</span> T_min)))</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>xvals <span class="op">=</span> <span class="fu">incrementalArray</span>(<span class="op">-</span><span class="dv">5</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="fl">0.1</span>)</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>yvals <span class="op">=</span> xvals<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> <span class="fu">flexTPC</span>(x<span class="op">,</span> T_min<span class="op">,</span> T_max<span class="op">,</span> r_max<span class="op">,</span> alpha<span class="op">,</span> beta))</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>zip <span class="op">=</span> (a<span class="op">,</span> b) <span class="kw">=&gt;</span> a<span class="op">.</span><span class="fu">map</span>((k<span class="op">,</span> i) <span class="kw">=&gt;</span> [k<span class="op">,</span> b[i]])<span class="op">;</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="fu">zip</span>(xvals<span class="op">,</span> yvals)</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>  <span class="dt">y</span><span class="op">:</span> { <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="fl">0.01</span><span class="op">,</span> <span class="fl">1.25</span>] }<span class="op">,</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">line</span>(</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>      data<span class="op">,</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"steelblue"</span><span class="op">,</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">ruleX</span>([<span class="dv">0</span>])<span class="op">,</span></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">ruleY</span>([<span class="dv">0</span>])<span class="op">,</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">axisX</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">"Temperature [°C]"</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span><span class="op">,</span> <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">40</span>})<span class="op">,</span></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">axisY</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">"trait performance"</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span><span class="op">,</span> <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span> })</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-7" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>(there’s supposed to be an interactive visualization above this line, hopefully this works on the website!).</p>
<section id="adding-the-flextpc-function-to-bayestpc" class="level3">
<h3 class="anchored" data-anchor-id="adding-the-flextpc-function-to-bayestpc">Adding the flexTPC function to bayesTPC</h3>
<p>We want to add the flexTPC functional form to bayesTPC. To do this, we need two things:</p>
<ul>
<li><p>We need to define an expression with the formula we want to use.</p></li>
<li><p>We need to define default prior distributions for every parameter in the model. As we will be focusing on the antibiotic dataset presented earlier, we will define the priors we want to use in this case here directly rather than code in default non-restrictive priors.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Note: This looks a little different from the equation as written above, but is</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="do">## equivalent to it. It's just written a little differently for numerical stability.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>flexTPC_formula <span class="ot">&lt;-</span> <span class="fu">expression</span>((T_max <span class="sc">&gt;</span> Temp) <span class="sc">*</span> (T_min <span class="sc">&lt;</span> Temp) <span class="sc">*</span> r_max <span class="sc">*</span> <span class="fu">exp</span>((alpha <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> (alpha <span class="sc">*</span> <span class="fu">log</span>( <span class="fu">max</span>((Temp <span class="sc">-</span> T_min) <span class="sc">/</span> alpha, <span class="dv">10</span><span class="sc">^-</span><span class="dv">20</span>)) </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                                                                    <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> <span class="fu">log</span>(<span class="fu">max</span> ((T_max <span class="sc">-</span> Temp) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> alpha), <span class="dv">10</span><span class="sc">^-</span><span class="dv">20</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                                                                    <span class="sc">-</span> <span class="fu">log</span>(T_max <span class="sc">-</span> T_min)) ) )</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior distributions.</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>flexTPC_priors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_max =</span> <span class="st">"dunif(0, 1)"</span>, <span class="co"># Maximum trait value. Chosen because OD values are less than one and because we want to give equal prior probability to all values in the [0, 1] interval.</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">T_max =</span> <span class="st">"dnorm(46, 1 / 2^2)"</span>, <span class="do">## Normal prior with mu=46, sigma=2. Assumes 95% prior CI of approximately [42°C, 50°C].</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">T_min =</span> <span class="st">"dnorm(10, 1 / 5^2)"</span>, <span class="do">## Normal prior with mu=10, sigma=5. Assumes 95% prior CI of approximately [0°C, 20°C]</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="st">"dunif(0, 1)"</span>, <span class="do">## Uniform prior in alpha places equal prior probability on T_opt being anywhere in-between T_min and T_max.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta =</span> <span class="st">"dgamma(0.3^2 / 0.2^2, 0.3 / 0.2^2)"</span>) <span class="do">## Gamma prior with mean of 0.3 and standard deviation of 0.2. Asssumes 95% prior CI of approx [0.01, 0.99] for beta. Typical TPCs like those that are described by the Briere and quadratic models have values around 0.2-0.4.</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>flexTPC_normal <span class="ot">&lt;-</span> <span class="fu">specify_normal_model</span>(<span class="st">"flexTPC_normal"</span>, <span class="co">#model name</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parameters =</span> flexTPC_priors, <span class="co">#names are parameters, values are priors</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">formula =</span> flexTPC_formula</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model type 'flexTPC_normal' can now be accessed using other bayesTPC functions. Restart R to reset back to defaults.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_formula</span>(<span class="st">"flexTPC_normal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>expression((T_max &gt; Temp) * (T_min &lt; Temp) * r_max * exp((alpha * 
    (1 - alpha)/beta^2) * (alpha * log(max((Temp - T_min)/alpha, 
    10^-20)) + (1 - alpha) * log(max((T_max - Temp)/(1 - alpha), 
    10^-20)) - log(T_max - T_min))))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_default_priors</span>(<span class="st">"flexTPC_normal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               r_max                                T_max 
                       "dunif(0, 1)"                 "dnorm(46, 1 / 2^2)" 
                               T_min                                alpha 
                "dnorm(10, 1 / 5^2)"                        "dunif(0, 1)" 
                                beta 
"dgamma(0.3^2 / 0.2^2, 0.3 / 0.2^2)" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">configure_model</span>(flexTPC_normal))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    for (i in 1:N){
        m[i] &lt;- ( (T_max &gt; Temp[i]) * (T_min &lt; Temp[i]) * r_max * exp((alpha * (1 - alpha)/beta^2) * (alpha * log(max((Temp[i] - T_min)/alpha, 10^-20)) + (1 - alpha) * log(max((T_max - Temp[i])/(1 - alpha), 10^-20)) - log(T_max - T_min))) )
        Trait[i] ~ T(dnorm(mean = m[i], tau = 1/sigma.sq), 0, )
    }
    r_max ~ dunif(0, 1)
    T_max ~ dnorm(46, 1 / 2^2)
    T_min ~ dnorm(10, 1 / 5^2)
    alpha ~ dunif(0, 1)
    beta ~ dgamma(0.3^2 / 0.2^2, 0.3 / 0.2^2)
    sigma.sq ~ dexp(1)
}</code></pre>
</div>
</div>
<p>Now let’s get the data in the right shape and fit the flexTPC model to all these conditions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>nodrug.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> nodrug<span class="sc">$</span>OD, <span class="at">Temp=</span>nodrug<span class="sc">$</span>T)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>nodrugFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> nodrug.data.bTPC, <span class="do">## data</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.8</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.8</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.
 - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>GEN.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> GEN<span class="sc">$</span>OD, <span class="at">Temp=</span>GEN<span class="sc">$</span>T)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>GENFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> GEN.data.bTPC, <span class="do">## data</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.5</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.7</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.
 - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>ERY.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> ERY<span class="sc">$</span>OD, <span class="at">Temp=</span>ERY<span class="sc">$</span>T)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ERYFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> ERY.data.bTPC, <span class="do">## data</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.8</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.8</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.
 - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>both.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> both<span class="sc">$</span>OD, <span class="at">Temp=</span>both<span class="sc">$</span>T)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>bothFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> both.data.bTPC, <span class="do">## data</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.8</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.8</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.
 - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
</div>
<p>Most of the traceplots look OK, but here is an example of one that doesn’t look great:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(ERYFit, <span class="at">burn=</span><span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see than not all of our samples look like a “hairy caterpillar”. As can be seen in the traceplot for <span class="math inline">\(r_{\max}\)</span>, ocassionally the samples seem to “get stuck” in some regions of the parameter space. This means the MCMC chains may be converging slowly for some parameters.</p>
<p>There’s a few things that can help with convergence of the MCMC chains:</p>
<ul>
<li><p>Try another sampler.</p></li>
<li><p>Try setting the initial values of the parameters to values that are likely to be near the best fitting values.</p></li>
<li><p>Use stronger prior distributions.</p></li>
<li><p>Run the chains for longer.</p></li>
</ul>
<p>There are also some diagnostics based on running multiple chains (ideally started from different initial values) that can help us evaluate convergence based on how similar the samples from the different chains are to each other. Future versions of bayesTPC will include the ability to run multiple chains and some of these diagnostics.</p>
<p>In this tutorial we’re running the chains for 50000 iterations (instead of 10000 as in previous examples) and providing reasonable initial values which improved sampling compared to initial experiments with shorter runs. For final results, we’d likely run the chains even longer to be safe, although it wouldn’t be practical to do this here due to time constraints.</p>
<p>However, most of the parameters show good mixing and the TPCs we get look reasonable when plotted with the data (see below). So it’s likely OK to use our samples for the analysis.</p>
</section>
</section>
<section id="advanced-topic-transformations-of-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="advanced-topic-transformations-of-model-parameters">Advanced topic: Transformations of model parameters</h2>
<p>The logical next step before proceeding with the analysis is to plot the curves along with the data. However, we will do this a little bit later in this practical, since we want to show how to do this directly from the MCMC samples to see how we can customize our plots.</p>
<p>When using MCMC methods, we obtain samples from the posterior distribution of the parameters in our model. Let’s take a look at the first few samples from the condition with no antibiotics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nodrugFit<span class="sc">$</span>samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Markov Chain Monte Carlo (MCMC) output:
Start = 1 
End = 7 
Thinning interval = 1 
        T_max    T_min     alpha      beta     r_max     sigma.sq
[1,] 44.05463 17.08606 0.8449004 0.3635676 0.7712699 0.0018935016
[2,] 44.11451 17.72193 0.8145201 0.3705644 0.8236235 0.0019121465
[3,] 44.05575 18.21946 0.8370196 0.3896825 0.7752230 0.0020226051
[4,] 44.02862 18.74204 0.8270065 0.4136436 0.7827661 0.0010952376
[5,] 44.05624 18.34766 0.8223852 0.3823176 0.8002245 0.0012067834
[6,] 44.05852 16.85119 0.8326278 0.3620327 0.8094334 0.0012262096
[7,] 44.08089 17.78250 0.8244900 0.3770205 0.7806865 0.0008386678</code></pre>
</div>
</div>
<p>Each row corresponds to the values of the parameters in one iteration of the chain. Once the MCMC chain has reached convergence, each iteration corresponds to drawing a sample from the posterior distribution.</p>
<p>We can plot the posterior distribution for the individual parameters using these samples. For example, we may want to compare the height of the TPCs (which corresponds to parameter <span class="math inline">\(r_{\max}\)</span>) between the different antibiotic backgrounds. In this data, this would correspond to the maximum OD (proportional to number of bacteria) that grow under the corresponding antibiotic condition at any temperature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"No drug"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ERYFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(GENFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bothFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY+GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also use the MCMC samples to obtain the posterior distribution of any function involving the model parameters. For example, we might be interested in the difference between the maximum growth observed under the conditions with antibiotics present and when there is no antibiotics (note: to do this we need to have the same number of samples for all chains we are comparing).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ERYFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">xlab=</span><span class="st">"r_max difference"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(GENFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max difference"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( bothFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY+GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max difference"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s calculate medians and credible intervals for this differences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"ERY"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ERY"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(ERYFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      2.5%        50%      97.5% 
-0.3208848 -0.1515718  0.1625109 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"GEN"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "GEN"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(GENFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      2.5%        50%      97.5% 
-0.4946654 -0.4454704 -0.3999379 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"ERY+GEN"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ERY+GEN"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(bothFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       2.5%         50%       97.5% 
-0.35603488 -0.27941308 -0.05812275 </code></pre>
</div>
</div>
<p>In the flexTPC model we have an explicit equation for the optimal temperature</p>
<p><span class="math display">\[ T_{\mathrm{opt}} = \alpha T_{\max} + (1 - \alpha) T_{\min} \]</span></p>
<p>Using this equation, we can also get posterior samples for <span class="math inline">\(T_{\mathrm{opt}}\)</span> by transforming the posterior samples for <span class="math inline">\(T_{\min}\)</span>, <span class="math inline">\(T_{\max}\)</span> and <span class="math inline">\(\alpha\)</span>. For example, for the no-antibiotics condition,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate Topt in flexTPC model from Tmin, Tmax and alpha.</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>T_opt_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(Tmin, Tmax, alpha) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(alpha <span class="sc">*</span> Tmax <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> Tmin)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>T_opt_samples <span class="ot">&lt;-</span> <span class="fu">apply</span>(nodrugFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">T_opt_fn</span>(x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]], x[[<span class="st">'alpha'</span>]]))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(T_opt_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can then obtain summaries of the posterior distribution of <span class="math inline">\(T_{\mathrm{opt}}\)</span> such as the mean, median and/or credible intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(T_opt_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.11676</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(T_opt_samples, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5%      50%    97.5% 
37.81394 39.11013 40.42002 </code></pre>
</div>
</div>
<p>We can follow a similar approach to obtain the posterior distribution of the value of the curve at any temperature (or a grid of temperatures). In this case, the transformation of the parameters we want is simply the equation for the flexTPC model itself. With this equation, we can get the posterior distribution of the TPC at specific temperatures. We can then directly calculate medians and credible intervals to plot the TPCs.</p>
<p>It can be useful to calculate these values directly if we want to customize our plots to make them nicer compared to the bayesTPC defaults. Let’s look at an example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Grid of temperatures to use to plot the TPCs.</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">11</span>, <span class="dv">49</span>, <span class="fl">0.1</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># FlexTPC equation</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>flexTPC <span class="ot">&lt;-</span> <span class="cf">function</span>(T, Tmin, Tmax, rmax, alpha, beta) {</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> alpha <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  Tidx <span class="ot">&lt;-</span> (T <span class="sc">&gt;</span> Tmin) <span class="sc">&amp;</span> (T <span class="sc">&lt;</span> Tmax)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(T))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  result[Tidx] <span class="ot">&lt;-</span> rmax <span class="sc">*</span> <span class="fu">exp</span>(s <span class="sc">*</span>(alpha <span class="sc">*</span> <span class="fu">log</span>((T[Tidx] <span class="sc">-</span> Tmin) <span class="sc">/</span> alpha ) <span class="sc">+</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>                             (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> <span class="fu">log</span>((Tmax <span class="sc">-</span> T[Tidx]) <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">-</span> alpha) )</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">-</span> <span class="fu">log</span>(Tmax <span class="sc">-</span> Tmin)))</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nodrug<span class="sc">$</span>T, nodrug<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"No drug"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>ndcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(nodrugFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'black'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"black"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(GEN<span class="sc">$</span>T, GEN<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>GENcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(GENFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'steelblue'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"steelblue"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ERY<span class="sc">$</span>T, ERY<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>ERYcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(ERYFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'darkgreen'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"darkgreen"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(both<span class="sc">$</span>T, both<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN+ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>bothcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(bothFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"purple"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also plot all the TPCs together to more easily compare them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="fl">0.1</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="st">""</span>, <span class="st">""</span>, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"All TPCs"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>ndcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(nodrugFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'black'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"black"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>GENcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(GENFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'steelblue'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"steelblue"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>ERYcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(ERYFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'darkgreen'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"darkgreen"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>bothcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(bothFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"purple"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, the curve with no antibiotics is shown in black. We can see that the GEN+ERY (purple) curve looks very similar to the curve with only ERY (green). In both cases, the number of bacteria is reduced more sharply at low temperatures. The TPC for GEN (blue) looks very different, reducing the number of bacteria more sharply at high temperatures.</p>
</section>
<section id="model-selection" class="level2">
<h2 class="anchored" data-anchor-id="model-selection">Model selection</h2>
<p>In this section, we show how we can compare between different models with bayesTPC using WAIC. We will compare two candidate models:</p>
<p>a) A single TPC model for all of the antibiotic conditions. This corresponds to a null hypothesis of antibiotics not affecting the thermal performance curve.</p>
<p>b) Separate TPC models for each antibiotic background, as we had before.</p>
<p>Let’s fit the model that treats all data as coming from the same thermal performance curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a single dataset with all data.</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>allconds <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(nodrug, GEN, ERY, both)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>allconds.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> allconds<span class="sc">$</span>OD, <span class="at">Temp=</span>allconds<span class="sc">$</span>T)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>allcondsFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> allconds.data.bTPC, <span class="do">## data</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin=</span><span class="dv">2</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.
 - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
</div>
<p>Now let’s plot the TPC fit of the null-hypothesis model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(allconds<span class="sc">$</span>T, allconds<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"All data together"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>accurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(allcondsFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(accurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'black'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(accurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(accurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"black"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesTPC_advanced_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can now do model selection through WAIC. First, let’s find the WAIC for the single curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(allcondsFit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       WAIC        lppd       pWAIC 
-120.208842   65.203846    5.099425 </code></pre>
</div>
</div>
<p>This gives us three values: WAIC (the main quantity we’re interested in), and two terms that are used to calculate the WAIC. These are the lppd (which measures how well the model fits the data) and pWAIC (a way to measure model complexity that depends on the number of parameters and how constrained they are by the priors). We can access the WAIC value itself with the following code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(allcondsFit)[[<span class="st">"WAIC"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -120.2088</code></pre>
</div>
</div>
<p>We can now find the WAICs from the individual curves. WAIC is additive, so we can simply add the WAICs for the individual curves to get a value that we can compare to the one we calculated above for the null model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>nodrugWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(nodrugFit)[[<span class="st">"WAIC"</span>]] </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>ERYWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(ERYFit)[[<span class="st">"WAIC"</span>]]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>GENWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(GENFit)[[<span class="st">"WAIC"</span>]]  </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>bothWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(bothFit)[[<span class="st">"WAIC"</span>]]</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>nodrugWAIC <span class="sc">+</span> ERYWAIC <span class="sc">+</span> GENWAIC <span class="sc">+</span> bothWAIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -395.8602</code></pre>
</div>
</div>
<p>The WAIC for the individual curves is much lower (more negative) than for the single curve describing all data. Based on this, modeling this data as individual TPCs is preferred compared to having a single curve for all conditions.</p>


</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InZpZXdvZiBUX21pbiA9IElucHV0cy5yYW5nZShcbiAgWy01LCAyMF0sIFxuICB7dmFsdWU6IDEwLCBzdGVwOiAwLjIsIGxhYmVsOiBcIlRtaW46XCJ9XG4pXG52aWV3b2YgVF9tYXggPSBJbnB1dHMucmFuZ2UoXG4gIFszMCwgNTBdLCBcbiAge3ZhbHVlOiAzNSwgc3RlcDogMC4yLCBsYWJlbDogXCJUbWF4OlwifVxuKVxuXG52aWV3b2Ygcl9tYXggPSBJbnB1dHMucmFuZ2UoXG4gIFswLCAxLjJdLCBcbiAge3ZhbHVlOiAxLCBzdGVwOiAwLjEsIGxhYmVsOiBcInJtYXg6XCJ9XG4pXG5cbnZpZXdvZiBhbHBoYSA9IElucHV0cy5yYW5nZShcbiAgWzAsIDFdLCBcbiAge3ZhbHVlOiAwLjgsIHN0ZXA6IDAuMDIsIGxhYmVsOiBcImFscGhhOlwifVxuKVxuXG52aWV3b2YgYmV0YSA9IElucHV0cy5yYW5nZShcbiAgWzAsIDFdLCBcbiAge3ZhbHVlOiAwLjMsIHN0ZXA6IDAuMDIsIGxhYmVsOiBcImJldGE6XCJ9XG4pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbmZ1bmN0aW9uIGluY3JlbWVudGFsQXJyYXkoc3RhcnQsIGVuZCwgc3RlcCkge1xuICAgIHZhciBhcnIgPSBbXTtcbiAgICAvLyBjb252ZXJ0IGNvdW50IHRvIGFuIGludGVnZXIgdG8gYXZvaWQgcm91bmRpbmcgZXJyb3JzXG4gICAgdmFyIGNvdW50ID0gKygoZW5kIC0gc3RhcnQpIC8gc3RlcCkudG9GaXhlZCgpO1xuICAgIGZvciAodmFyIGogPSAwOyBqIDw9IGNvdW50OyBqKyspIHtcbiAgICAgICAgdmFyIGkgPSBzdGFydCArIGogKiBzdGVwO1xuICAgICAgICBhcnIucHVzaChpKTtcbiAgICB9XG4gICAgcmV0dXJuIGFycjtcbn1cblxuZnVuY3Rpb24gZmxleFRQQyh4LCBUX21pbiwgVF9tYXgsIHJfbWF4LCBhbHBoYSwgYmV0YSkge1xuICBpZiAoeCA8IFRfbWluKSB7XG4gIHJldHVybiAwLjBcbiAgfVxuICBpZiAoeCA+IFRfbWF4KSB7XG4gIHJldHVybiAwLjBcbiAgfVxuICByZXR1cm4gcl9tYXggKiBNYXRoLmV4cCgoYWxwaGEgKiAoMS4wIC0gYWxwaGEpIC8gYmV0YSoqMikgKiAoYWxwaGEgKiAgICBNYXRoLmxvZyggKHggLSBUX21pbikgLyBhbHBoYSkgICsgXG4gICAgICAoMS4wIC0gYWxwaGEpICogTWF0aC5sb2coIChUX21heCAtIHgpIC8gKDEuMCAtIGFscGhhKSkgLVxuICAgICAgTWF0aC5sb2coVF9tYXggLSBUX21pbikpKVxufVxuXG54dmFscyA9IGluY3JlbWVudGFsQXJyYXkoLTUsIDUwLCAwLjEpXG55dmFscyA9IHh2YWxzLm1hcCgoeCkgPT4gZmxleFRQQyh4LCBUX21pbiwgVF9tYXgsIHJfbWF4LCBhbHBoYSwgYmV0YSkpXG56aXAgPSAoYSwgYikgPT4gYS5tYXAoKGssIGkpID0+IFtrLCBiW2ldXSk7XG5kYXRhID0gemlwKHh2YWxzLCB5dmFscylcblxuUGxvdC5wbG90KHtcbiAgd2lkdGg6IDYwMCxcbiAgaGVpZ2h0OiA0MDAsXG4gIHk6IHsgZG9tYWluOiBbLTAuMDEsIDEuMjVdIH0sXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5saW5lKFxuICAgICAgZGF0YSxcbiAgICAgIHtcbiAgICAgICAgc3Ryb2tlV2lkdGg6IDMsXG4gICAgICAgIHN0cm9rZTogXCJzdGVlbGJsdWVcIixcbiAgICAgICAgZm9udFNpemU6IDE0XG4gICAgICB9XG4gICAgKSxcbiAgICBQbG90LnJ1bGVYKFswXSksXG4gICAgUGxvdC5ydWxlWShbMF0pLFxuICAgIFBsb3QuYXhpc1goe2xhYmVsOiBcIlRlbXBlcmF0dXJlIFvCsENdXCIsIGZvbnRTaXplOiAxNCwgbWFyZ2luQm90dG9tOiA0MH0pLFxuICAgIFBsb3QuYXhpc1koe2xhYmVsOiBcInRyYWl0IHBlcmZvcm1hbmNlXCIsIGZvbnRTaXplOiAxNCwgeDogMCB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdUX21pbicpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdUX21heCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdyX21heCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdhbHBoYScpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdiZXRhJykifV19
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../..";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>